<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบประชาสัมพันธ์ของโรงเรียน</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Sarabun', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
    .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
    .animate-fade-in { animation: fadeIn .5s ease-in; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(20px)} to {opacity:1; transform: translateY(0)} }
    .line-clamp-3{
      display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
    }
    .chip{ @apply px-3 py-1 rounded-full text-sm font-semibold; }
    .prose{
        --tw-prose-body: #374151;
        --tw-prose-headings: #1f2937;
        --tw-prose-links: #4f46e5;
        --tw-prose-bold: #111827;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <header class="gradient-bg text-white shadow-lg">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="bg-white/20 p-2 rounded-lg">
            <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
              <path d="M4 4h16v4H4V4zm0 6h10v10H4V10zm12 0h4v10h-4V10z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold">ระบบประชาสัมพันธ์ของโรงเรียน</h1>
            <p class="text-blue-100 text-sm">ประกาศ · กิจกรรม · แจ้งด่วน</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="showForm()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition flex items-center gap-2">
            <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
            <span>สร้างประกาศ</span>
          </button>
          <button onclick="showList()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition flex items-center gap-2">
            <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v1H2V5zm0 3h16v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8zm4 2h8v2H6v-2z" clip-rule="evenodd"/></svg>
            <span>ดูประกาศ</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-6 py-8">
    <section id="formSection" class="hidden animate-fade-in">
      <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-xl card-shadow p-8">
          <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">สร้าง/แจ้งประกาศ</h2>
            <p class="text-gray-600">กรอกข้อมูลประกาศที่ต้องการเผยแพร่</p>
          </div>
          <form id="announceForm" class="space-y-6">
            <input type="hidden" id="editId">
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">หมวดประกาศ</label>
                <select id="category" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                  <option value="">เลือกหมวด</option>
                  <option>ประกาศทั่วไป</option>
                  <option>กิจกรรม/ค่าย/ทัศนศึกษา</option>
                  <option>ด่วนที่สุด</option>
                  <option>แจ้งปิดเรียน/เลื่อน</option>
                  <option>ทุนการศึกษา</option>
                  <option>รับสมัคร/แข่งขัน</option>
                  <option>สุขภาพ/ความปลอดภัย</option>
                  <option>อื่น ๆ</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">ความเร่งด่วน</label>
                <select id="urgency" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                  <option value="">เลือกระดับ</option>
                  <option>ปกติ</option>
                  <option>เร่งด่วน</option>
                  <option>ด่วนมาก</option>
                  <option>ด่วนที่สุด</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">หัวข้อประกาศ</label>
              <input id="title" type="text" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">เนื้อหาประกาศ</label>
              <textarea id="content" rows="4" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required></textarea>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">ผู้ประกาศ</label>
                <input id="author" type="text" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">ช่องทางติดต่อ (ถ้ามี)</label>
                <input id="contact" type="text" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
              </div>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">วันที่เผยแพร่</label>
                <input id="publishDate" type="datetime-local" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">วันหมดอายุ (ถ้ามี)</label>
                <input id="expireDate" type="datetime-local" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
              </div>
              <div class="flex items-end">
                <label class="inline-flex items-center gap-3 w-full">
                  <input id="pinned" type="checkbox" class="w-5 h-5">
                  <span class="text-sm font-semibold text-gray-700">ปักหมุดประกาศ</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">กลุ่มเป้าหมาย</label>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <label class="flex items-center gap-2"><input type="checkbox" class="aud" value="นักเรียน" checked> นักเรียน</label>
                <label class="flex items-center gap-2"><input type="checkbox" class="aud" value="ผู้ปกครอง" checked> ผู้ปกครอง</label>
                <label class="flex items-center gap-2"><input type="checkbox" class="aud" value="ครู/บุคลากร" checked> ครู/บุคลากร</label>
                <label class="flex items-center gap-2"><input type="checkbox" class="aud" value="ชุมชน"> ชุมชน</label>
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">ลิงก์แนบ (ถ้ามี)</label>
              <input id="link" type="url" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="pt-2">
              <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white font-semibold py-4 px-6 rounded-lg transition transform hover:scale-[1.02] shadow-lg">
                เผยแพร่ประกาศ
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <section id="listSection" class="hidden animate-fade-in">
      <div class="max-w-6xl mx-auto">
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-gray-800 mb-2">รายการประกาศ</h2>
          <p class="text-gray-600">ค้นหาและกรองประกาศที่เผยแพร่ล่าสุด</p>
        </div>
        <div class="bg-white rounded-xl card-shadow p-4 mb-6">
          <div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4">
            <div class="flex-1">
              <input id="q" type="text" class="w-full px-4 py-2.5 border rounded-lg" placeholder="ค้นหา...">
            </div>
            <select id="filterCategory" class="px-4 py-2.5 border rounded-lg"><option value="all">ทุกหมวด</option></select>
            <select id="filterUrgency" class="px-4 py-2.5 border rounded-lg"><option value="all">ทุกความเร่งด่วน</option><option>ปกติ</option><option>เร่งด่วน</option><option>ด่วนมาก</option><option>ด่วนที่สุด</option></select>
            <select id="filterAudience" class="px-4 py-2.5 border rounded-lg"><option value="all">ทุกกลุ่มเป้าหมาย</option><option>นักเรียน</option><option>ผู้ปกครอง</option><option>ครู/บุคลากร</option><option>ชุมชน</option></select>
            <select id="sortBy" class="px-4 py-2.5 border rounded-lg"><option value="latest">ล่าสุดก่อน</option><option value="oldest">เก่าสุดก่อน</option><option value="pinned">ปักหมุดก่อน</option></select>
            <label class="flex items-center gap-2 text-sm px-2"><input id="showExpired" type="checkbox"> แสดงหมดอายุ</label>
            <button id="clearFiltersBtn" class="w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2.5 rounded-lg transition">ล้างค่า</button>
          </div>
        </div>
        <div id="chipBar" class="mb-6 flex flex-wrap gap-2 justify-center"></div>
        <div id="announceList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>
    </section>
  </main>
  
  <div id="successModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center animate-fade-in">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-green-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
      </div>
      <h3 class="text-xl font-bold text-gray-800 mb-2">สำเร็จ!</h3>
      <p class="text-gray-600 mb-6">ดำเนินการเรียบร้อยแล้ว</p>
      <button onclick="closeModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition">ตกลง</button>
    </div>
  </div>
  <div id="detailModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
    <div id="detailModalContent" class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 animate-fade-in relative max-h-[90vh] overflow-y-auto"></div>
  </div>

  <script>
    /* ---------- Config & DOM Caching ---------- */
    const API_URL = 'https://script.google.com/macros/s/AKfycbziMGN6YFDixrR20Avqr6duiJNgFco5_qrGtFY7nfmtztide0IqM7Yp5NJ0iitnYKvk/exec';
    let announces = [];

    const formSection = document.getElementById('formSection');
    const listSection = document.getElementById('listSection');
    const announceForm = document.getElementById('announceForm');
    const successModal = document.getElementById('successModal');
    const detailModal = document.getElementById('detailModal');
    const detailModalContent = document.getElementById('detailModalContent');
    const announceList = document.getElementById('announceList');
    const chipBar = document.getElementById('chipBar');
    const filterCategory = document.getElementById('filterCategory');
    const createBtn = document.querySelector('header button[onclick="showForm()"]');
    const listBtn = document.querySelector('header button[onclick="showList()"]');
    
    const CATEGORIES = ['ประกาศทั่วไป', 'กิจกรรม/ค่าย/ทัศนศึกษา', 'ด่วนที่สุด', 'แจ้งปิดเรียน/เลื่อน', 'ทุนการศึกษา', 'รับสมัคร/แข่งขัน', 'สุขภาพ/ความปลอดภัย', 'อื่น ๆ'];

    /* ---------- Utilities ---------- */
    const thDate = (d) => d ? new Date(d).toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' }) : '';
    const toLocalISOString = (iso) => iso ? new Date(new Date(iso).getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16) : '';
    const getUrgencyColor = u => ({'ปกติ':'bg-gray-100 text-gray-800','เร่งด่วน':'bg-amber-100 text-amber-800','ด่วนมาก':'bg-orange-100 text-orange-800','ด่วนที่สุด':'bg-red-100 text-red-800'}[u] || 'bg-gray-100');
    const getCategoryColor = c => ({'ประกาศทั่วไป':'bg-indigo-100 text-indigo-800','กิจกรรม/ค่าย/ทัศนศึกษา':'bg-blue-100 text-blue-800','ด่วนที่สุด':'bg-red-100 text-red-800','แจ้งปิดเรียน/เลื่อน':'bg-violet-100 text-violet-800','ทุนการศึกษา':'bg-emerald-100 text-emerald-800','รับสมัคร/แข่งขัน':'bg-cyan-100 text-cyan-800','สุขภาพ/ความปลอดภัย':'bg-pink-100 text-pink-800','อื่น ๆ':'bg-gray-100 text-gray-800'}[c] || 'bg-gray-100');
    const escapeHTML = s => (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    /* ---------- View Switching & Modals ---------- */
    const showView = (view) => {
      const isForm = view === 'form';
      formSection.classList.toggle('hidden', !isForm);
      listSection.classList.toggle('hidden', isForm);
      createBtn.classList.toggle('bg-white/30', isForm);
      listBtn.classList.toggle('bg-white/30', !isForm);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    const showForm = (isEditing = false) => {
      if (!isEditing) {
        announceForm.reset();
        document.getElementById('editId').value = '';
        document.querySelector('#formSection h2').textContent = 'สร้าง/แจ้งประกาศ';
      }
      showView('form');
    };
    const showList = () => { showView('list'); fetchAnnouncements(); };
    const closeModal = () => { successModal.classList.add('hidden'); showList(); };
    const closeDetailModal = () => detailModal.classList.add('hidden');

    /* ---------- API Communication ---------- */
    async function fetchAnnouncements() {
        announceList.innerHTML = `<div class="col-span-full text-center p-8">กำลังโหลดข้อมูล...</div>`;
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error('Network error');
            announces = await response.json();
            renderList();
        } catch (error) {
            announceList.innerHTML = `<div class="col-span-full text-center text-red-500 p-8">ไม่สามารถโหลดข้อมูลได้: ${error.message}</div>`;
        }
    }

    async function postData(action, data) {
        const body = { action, data };
        if (data.id) body.data.id = data.id;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(body),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            successModal.classList.remove('hidden');
        } catch (error) {
            alert(`เกิดข้อผิดพลาด: ${error.message}`);
        }
    }

    announceForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const editId = document.getElementById('editId').value;
        const itemData = {
            id: editId,
            category: document.getElementById('category').value,
            urgency: document.getElementById('urgency').value,
            title: document.getElementById('title').value.trim(),
            content: document.getElementById('content').value.trim(),
            author: document.getElementById('author').value.trim(),
            contact: document.getElementById('contact').value.trim(),
            audiences: Array.from(document.querySelectorAll('.aud:checked')).map(i => i.value),
            link: document.getElementById('link').value.trim(),
            pinned: document.getElementById('pinned').checked,
            publishDate: document.getElementById('publishDate').value ? new Date(document.getElementById('publishDate').value).toISOString() : new Date().toISOString(),
            expireDate: document.getElementById('expireDate').value ? new Date(document.getElementById('expireDate').value).toISOString() : ''
        };
        postData(editId ? 'update' : 'create', itemData);
    });

    const deleteItem = (id) => { if (confirm('ยืนยันการลบ?')) postData('delete', { id }); };

    /* ---------- Rendering ---------- */
    const isExpired = item => item.expireDate && new Date(item.expireDate).getTime() < Date.now();
    const audiencesBadges = auds => (auds || []).map(a => `<span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-xs font-semibold">${a}</span>`).join(' ');

    function renderList() {
        const q = (document.getElementById('q').value || '').toLowerCase();
        const cat = document.getElementById('filterCategory').value;
        const urg = document.getElementById('filterUrgency').value;
        const aud = document.getElementById('filterAudience').value;
        const sort = document.getElementById('sortBy').value;
        const showExp = document.getElementById('showExpired').checked;

        let data = announces.filter(it => {
            const exp = isExpired(it);
            return (showExp || !exp) &&
                   (cat === 'all' || it.category === cat) &&
                   (urg === 'all' || it.urgency === urg) &&
                   (aud === 'all' || (it.audiences || []).includes(aud)) &&
                   [it.title, it.content, it.author].join(' ').toLowerCase().includes(q);
        });

        data.sort((a, b) => {
            if (sort === 'pinned') {
                if ((b.pinned ? 1 : 0) !== (a.pinned ? 1 : 0)) return (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0);
            }
            const dateA = new Date(a.publishDate);
            const dateB = new Date(b.publishDate);
            return sort === 'oldest' ? dateA - dateB : dateB - dateA;
        });

        announceList.innerHTML = data.length ? data.map(cardHTML).join('') : `<div class="col-span-full text-center p-8">ไม่พบประกาศ</div>`;
    }

    function cardHTML(it) {
        return `
        <div class="bg-white rounded-xl card-shadow flex flex-col transition transform hover:-translate-y-1 hover:shadow-xl ${isExpired(it) ? 'opacity-60' : ''}">
          <div class="p-6 flex-grow cursor-pointer hover:bg-gray-50/50 rounded-t-xl" onclick="showDetailModal('${it.id}')">
            <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
              <div class="flex gap-2 items-center flex-wrap">
                ${it.pinned ? `<span class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 text-xs font-semibold">ปักหมุด</span>` : ''}
                <span class="chip ${getUrgencyColor(it.urgency)}">${it.urgency}</span>
              </div>
              <span class="chip ${getCategoryColor(it.category)}">${it.category}</span>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-1">${escapeHTML(it.title)}</h3>
            <p class="text-gray-600 text-sm line-clamp-3 mb-3">${escapeHTML(it.content)}</p>
          </div>
          <div class="border-t p-3 bg-gray-50 rounded-b-xl flex items-center justify-between text-xs text-gray-500">
            <span>${thDate(it.publishDate)}${isExpired(it) ? ' <span class="text-red-600 font-semibold">· หมดอายุ</span>' : ''}</span>
            <div class="flex gap-2">
              <button onclick="editItem('${it.id}')" title="แก้ไข"><svg class="w-5 h-5 text-gray-500 hover:text-indigo-600" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"/></svg></button>
              <button onclick="deleteItem('${it.id}')" title="ลบ"><svg class="w-5 h-5 text-gray-500 hover:text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"/></svg></button>
            </div>
          </div>
        </div>`;
    }

    function showDetailModal(id) {
        const it = announces.find(item => item.id == id);
        if (!it) return;
        detailModalContent.innerHTML = `
          <button onclick="closeDetailModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
          <div class="flex items-start justify-between mb-4 flex-wrap gap-2">
            <div class="flex gap-2 items-center flex-wrap">
              ${it.pinned ? `<span class="chip bg-yellow-100 text-yellow-800">ปักหมุด</span>` : ''}
              <span class="chip ${getUrgencyColor(it.urgency)}">${it.urgency}</span>
            </div>
            <span class="chip ${getCategoryColor(it.category)}">${it.category}</span>
          </div>
          <h3 class="text-2xl font-bold text-gray-900 mb-2">${escapeHTML(it.title)}</h3>
          <div class="text-xs text-gray-500 mb-4 border-b pb-3">
            <span>ผู้ประกาศ: ${escapeHTML(it.author)} ${it.contact ? `· ${escapeHTML(it.contact)}` : ''}</span><br>
            <span>เผยแพร่: ${thDate(it.publishDate)}${isExpired(it) ? ' · <span class="text-red-600">หมดอายุแล้ว</span>' : ''}</span>
          </div>
          <div class="prose max-w-none text-gray-700 mb-4" style="white-space: pre-wrap;">${escapeHTML(it.content)}</div>
          <div class="flex flex-wrap gap-2 items-center mb-4"><strong class="text-sm">กลุ่มเป้าหมาย:</strong> ${audiencesBadges(it.audiences)}</div>
          ${it.link ? `<div class="mt-4 text-sm"><strong>ลิงก์:</strong> <a class="text-indigo-600 hover:underline break-all" href="${encodeURI(it.link)}" target="_blank" rel="noopener">${escapeHTML(it.link)}</a></div>` : ''}
        `;
        detailModal.classList.remove('hidden');
    }
    
    function editItem(id) {
        const item = announces.find(it => it.id == id);
        if (!item) return;
        document.querySelector('#formSection h2').textContent = 'แก้ไขประกาศ';
        Object.keys(item).forEach(key => {
            const el = document.getElementById(key);
            if (el) {
                if (el.type === 'checkbox') el.checked = item[key];
                else if (el.type === 'datetime-local') el.value = toLocalISOString(item[key]);
                else el.value = item[key];
            }
        });
        document.getElementById('editId').value = item.id;
        document.querySelectorAll('.aud').forEach(chk => { chk.checked = (item.audiences || []).includes(chk.value); });
        showForm(true);
    }
    
    /* ---------- Initial Load & Event Listeners ---------- */
    function init() {
        CATEGORIES.forEach(c => {
            const opt = document.createElement('option');
            opt.textContent = c; opt.value = c;
            filterCategory.appendChild(opt);
        });
        const chipElement = (label, value, active) => {
            const btn = document.createElement('button');
            btn.className = `px-4 py-2 rounded-full text-sm ${active ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'} hover:opacity-90 transition`;
            btn.textContent = label;
            btn.onclick = () => { document.getElementById('filterCategory').value = value; renderChips(value); renderList(); };
            return btn;
        };
        const renderChips = (active = 'all') => {
            chipBar.innerHTML = '';
            chipBar.appendChild(chipElement('ทั้งหมด', 'all', active === 'all'));
            CATEGORIES.forEach(c => chipBar.appendChild(chipElement(c, c, active === c)));
        };
        renderChips('all');

        ['q', 'filterCategory', 'filterUrgency', 'filterAudience', 'sortBy', 'showExpired'].forEach(id => document.getElementById(id).addEventListener('input', renderList));
        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            document.getElementById('q').value = '';
            filterCategory.value = 'all';
            document.getElementById('filterUrgency').value = 'all';
            document.getElementById('filterAudience').value = 'all';
            document.getElementById('sortBy').value = 'latest';
            document.getElementById('showExpired').checked = false;
            renderChips('all');
            renderList();
        });
        showList();
    }

    init();
  </script>
</body>
</html>
